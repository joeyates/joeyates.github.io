

<!DOCTYPE html>
<html lang="en">
<head>
<title>Regular Expressions in SQLite with Ruby - Joe Yates' Blog</title>
<meta content="When using SQLite via Ruby, you can use implement functions in Ruby and call them from SQL" name="description">
<meta content="width=device-width" name="viewport">
<link href="/sitemap.xml" rel="sitemap" title="Sitemap" type="application/xml">
<link href="/assets/app-cb475e5b8a234b2a45f4bc6cceeb180c.css" media="all" rel="stylesheet">
<script defer="true" src="/assets/application-04330b44b64bd6872cdc831811bd0720.js" type="text/javascript"></script>
</head>
<body class="font-sans text-xl bg-olive flex justify-center">
<div class="max-w-full min-h-screen md:w-[40rem] bg-light-olive py-4 px-10 flex flex-col">
<header>
<nav>
<ul class="flex list-none">
<li class="mr-8">
<a href="/">Home</a></li>
<li class="mr-8">
<a href="/posts/">Archives</a></li>
<li>
<a href="/categories/">Categories</a></li></ul></nav>
<div class="prose">
<h1>
Regular Expressions in SQLite with Ruby</h1></div></header>

<main class="max-w-full grow mx-1">

<section class="space-y-4 prose">
<div class="flex justify-end mb-4">
<div>2010/01/31</div>
</div>
<h2 class="text-lg">
When using SQLite via Ruby, you can use implement functions in Ruby and call them from SQL
</h2>
<p>Recently, I was writing an autocomplete method in a Ruby on Rails application. I wanted to find whole word matches, and words starting with the entered text.</p><p>The regular expression I wanted to use was like this:</p><pre title="language: ruby"><code class="language-ruby">word =~ /\W#{query}/</code></pre><p></p><p>So, if the user entered <code>'and'</code>, I wanted to retrieve <b><code>'And</code></b><code>es</code>' and '<code>Bill </code><b><code>and</code></b><code> Ben</code>', but not '<code>c</code><b><code>and</code></b><code>le</code>'.</p><p>In development I was using an SQLite database, and SQLite does not yet implement a regular expression operator. Actually, it <em>defines</em> the `REGEX` operator, but it doesn't implement it - if you use it you get an error.</p><p>I tried writing the method with just the <code>LIKE</code> operator, but it was getting very long-winded: you have to jump through hoops to approximate the regex <code>\W</code> operator.</p><p>The <code>REGEXP</code> operator is just syntactic sugar for the (unimplemented) <a href="https://www.sqlite.org/lang_expr.html#regexp" target="_blank">regexp() function</a>. SQLite allows you to add external functions at runtime, so I realized that there must be a way around the limitation, but, initially I thought I had to implement <code>regexp()</code> as a C function.</p><p>I found <a href="http://stephen-veit.blogspot.com/2009/03/implementing-regexp-in-sqlite3.html" target="_blank">an article about implementing regexp() in Ruby</a>. It needed a bit of tweaking as in the Rails 2.3.x interface for SQLite <code>ActiveRecord::ConnectionAdapters::SQLite3Adapter.initialize()</code> takes 3 parameters, not 2.</p><p>I got `REGEXP` working by creating an initializer:</p><pre title="language: ruby"><code class="language-ruby">require 'active_record/connection_adapters/sqlite3_adapter'

class ActiveRecord::ConnectionAdapters::SQLite3Adapter
  def initialize(db, logger, config)
    super

    db.create_function('regexp', 2) do |func, pattern, expression|
       regexp = Regexp.new(pattern.to_s, Regexp::IGNORECASE)
       if expression.to_s.match(regexp)
         func.result = 1
       else
         func.result = 0
       end
     end
  end
end</code></pre><p>The proof of the pudding:</p><pre title="language: ruby"><code class="language-ruby">./script/console
>> Noun.find(:all, :conditions => ['name LIKE ?', '%and%']).collect(&:name)
=> ["Candle", "Bill and Ben", "Andes"]
>> Noun.find(:all, :conditions => ['name REGEXP ?', '\Wand']).collect(&:name)
=> ["Bill and Ben", "Andes"]</code></pre>
</section>
<ul class="paginate">
<li>

<a href="/posts/managing-multiple-gnu-screen-sessions/">← Newer</a></li>
<li>

<a href="/posts/callbacks-in-objective-c/">Older →</a></li></ul>
</main>
<footer class="bottom-0 mt-6">
<hr class="mb-4">

<div class="flex flex-row justify-between text-sm">
<div>
<span>Made with</span>
<a href="https://github.com/joeyates/fermo">Fermo</a>
</div>
<p>&copy; Joe Yates 2010</p>
</div></footer>
</div></body></html>

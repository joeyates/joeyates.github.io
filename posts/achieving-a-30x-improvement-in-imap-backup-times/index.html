

<!DOCTYPE html>
<html lang="en">
<head>
<title>Achieving a 30x improvement in imap-backup times - Joe Yates' Blog</title>
<meta content="I've implemented a "delayed writes" option for imap-backup to avoid excessive rewrites of the metadata on large mailboxes" name="description">
<meta content="width=device-width" name="viewport">
<link href="/sitemap.xml" rel="sitemap" title="Sitemap" type="application/xml">
<link href="/assets/app-cb475e5b8a234b2a45f4bc6cceeb180c.css" media="all" rel="stylesheet">
<script defer="true" src="/assets/application-04330b44b64bd6872cdc831811bd0720.js" type="text/javascript"></script>
</head>
<body class="font-sans text-xl bg-olive flex justify-center">
<div class="max-w-full min-h-screen md:w-[40rem] bg-light-olive py-4 px-10 flex flex-col">
<header>
<nav>
<ul class="flex list-none">
<li class="mr-8">
<a href="/">Home</a></li>
<li class="mr-8">
<a href="/posts/">Archives</a></li>
<li>
<a href="/categories/">Categories</a></li></ul></nav>
<div class="prose">
<h1>
Achieving a 30x improvement in imap-backup times</h1></div></header>

<main class="max-w-full grow mx-1">

<section class="space-y-4 prose">
<div class="flex justify-end mb-4">
<div>2023/08/21</div>
</div>
<h2 class="text-lg">
I've implemented a "delayed writes" option for imap-backup to avoid excessive rewrites of the metadata on large mailboxes
</h2>
<p>Until recently, <a href="https://github.com/joeyates/imap-backup" target="_blank">imap-backup</a>'s wrote emails and metadata to disk one-at-a-time. This approach made sense for small folders, and for machines with few resources, but with large folders, <a href="https://github.com/joeyates/imap-backup/issues/157#issue-1728385492" target="_blank">it could get very slow</a>.</p><div class="flex flex-col items-center not-prose"><img src="https://blog-cms.joeyates.info/api/media/file/backup-times-with-original-strategy.png" alt="Backup Times with Original Strategy" width="600" height="371"><div class="mt-1 text-sm text-gray-500 text-center">Backup Times with Original Strategy</div></div><p>With mailboxes with hundreds of thousands of messages, backup times were running for a couple of hours.</p><p>In fact, backup times increased exponentially with mailbox size.</p><div class="flex flex-col items-center not-prose"><img src="https://blog-cms.joeyates.info/api/media/file/existing-approach-logarithmic.png" alt="Mailbox sizes against original backup times on a logarithmic scale" width="635" height="458"><div class="mt-1 text-sm text-gray-500 text-center">Mailbox sizes against original backup times on a logarithmic scale</div></div><h2>The Cause</h2><p>imap-backup stores mailbox information in two files. One is a standard <a href="https://www.loc.gov/preservation/digital/formats/fdd/fdd000385.shtml" target="_blank">MBOXRD</a> flat file of messages. The other is a JSON metadata file, with a <code>.imap</code> extension.</p><p>The <code>.imap</code> file records the UID (message id), message flags ('Seen', 'Draft', etc) and the offset and length of the message in the <code>.mbox</code> file.</p><p>In order to avoid corruption, both files are written to in a synchronised way, and to roll back on errors. While writing to the <code>.mbox</code> file is a simple append for each message, the <code>.imap</code> file is completely rewritten on every save. So, backing up a 100 000 message mailbox means 100 000 writes to this file, with each write growing slightly larger and requiring JSON serialization of more data!</p><h2>Transactions</h2><p>The solution was to hold downloaded metadata in memory, write messages to disk and write the <code>.imap</code> file just once. I've called this the "delayed metadata" strategy.</p><p>In order to maintain integrity guarantees for the serialized mailbox, I created a transaction system for the <code>Serializer</code>, to wrap the appends to the mailbox and the metadata file.</p><pre title="language: ruby"><code class="language-ruby">download_serializer.transaction do
  downloader.run
  ...
end</code></pre><p></p><p>From <a href="https://github.com/joeyates/imap-backup/blob/a1ab83874568ba6d9287dd1a9df02e14e82c7eea/lib/imap/backup/account/folder_backup.rb#L30" target="_blank">/lib/imap/backup/acount/folder_backup.rb</a></p><p>If any error or exception occurs, the mailbox is rolled back to its starting point, and no metadata is ever written.</p><h2>The Other Strategy</h2><p>While working on this feature, I actually implemented another "delay everything" strategy, which also delayed writing the message data to the mailbox file. Doing so meant holding a lot more data in memory, and resulted in, at most, a marginal speed gain. So after running benchmarks on both strategies, I dropped the "delay everything" strategy - the extra complexity wasn't worth keeping.</p><h2>Handling Ctrl+C</h2><p>As, during the transaction, the on-disk data for the mailbox now gets ahead of the serialized metadata, I needed to avoid problems caused by manual interruption of a backup run.</p><p>To do this, the program traps <a href="https://docs.ruby-lang.org/en/master/SignalException.html" target="_blank">SignalExceptions</a> alongside the normal <a href="https://docs.ruby-lang.org/en/master/StandardError.html" target="_blank">StandardErrors</a> in the mailbox writer and the metadata serializer.</p><pre title="language: ruby"><code class="language-ruby">tsx.begin({savepoint: {length: length}}) do
  block.call
rescue StandardError => e
  message = &lt;&lt;~ERROR
    #{self.class} error #{e}
    #{e.backtrace.join("\n")}
  ERROR
  Logger.logger.error message
  rollback
  raise e
rescue SignalException => e
  Logger.logger.error "#{self.class} handling #{e.class}"
  rollback
  raise e
end</code></pre><p></p><p>From <a href="https://github.com/joeyates/imap-backup/blob/a1ab83874568ba6d9287dd1a9df02e14e82c7eea/lib/imap/backup/serializer/mbox.rb#L28" target="_self">lib/imap/backup/serializer/mbox.rb</a></p><p>Trapping <code>SignalException</code>s is unusual in Ruby - you should normally just let the program terminate, but in this case I feel doing so is justified in the name of data integrity.</p><p>In the mailbox writer, the rollback actually rewinds the file to its starting position</p><pre title="language: ruby"><code class="language-ruby">File.open(pathname, File::RDWR | File::CREAT, 0o644) do |f|
  f.truncate(length)
end</code></pre><p></p><p>While, in the metadata serializer, it just resets itself to the preceding metadata:</p><pre title="language: ruby"><code class="language-ruby">@messages = tsx.data[:savepoint][:messages]
@uid_validity = tsx.data[:savepoint][:uid_validity]
</code></pre><h2>Maintaining Two Strategies</h2><p>As this new system uses more memory that the original one-at-a-time approach, it might have caused problems on smaller systems with limited resources. For example, using a RaspberryPi to back up my email to disk is a common use case for imap-backup.</p><p>In order to allow users to keep resource usage to a minimum, if needed, I've kept the original strategy and added a configuration option to choose between the new, faster, strategy, and the old, less resource hungry, one.</p><pre title="language: plaintext"><code class="language-plaintext">Choose a Download Strategy:
1. write straight to disk
2. delay writing metadata &lt;- current
3. help
4. (q) return to main menu
?  </code></pre><p>As the new strategy works best except for the most resource-starved machines, I've made it the default.</p><h2>Benchmarks</h2><p>These benchmarks were run on a Framework Laptop with 16GB RAM and a solid-state disk.</p><p>The IMAP server used was a local Docker image running Dovecot.</p><p>Mailboxes were filled with the required number of identical messages, each 52 bytes long.</p><p>I chose sample sizes that grew exponentially:</p><p>1, 3, 7, 20, 55, 148, 403, 1097, 2981, 8103, 22026, 59874, 162755</p><p>Doing so means I can plot results on a logarithmic scale and get evenly spaced data points.</p><p>Each sample size was measured 4 times and then I took averages.</p><p>These are the results for the "straight to disk" strategy:</p><table><tr><th><p>Count</p></th><th><p>Run 1</p></th><th><p>Run 2</p></th><th><p>Run 3</p></th><th><p>Run 4</p></th><th><p>Average</p></th></tr><tr><th><p>1</p></th><td><p class="text-right">0.8107</p></td><td><p class="text-right">0.8101</p></td><td><p class="text-right">0.81012</p></td><td><p class="text-right">0.8159</p></td><td><p class="text-right">0.8117</p></td></tr><tr><th><p>3</p></th><td><p class="text-right">0.8103</p></td><td><p class="text-right">0.8124</p></td><td><p class="text-right">0.8109</p></td><td><p class="text-right">0.8107</p></td><td><p class="text-right">0.8111</p></td></tr><tr><th><p>7</p></th><td><p class="text-right">0.8104</p></td><td><p class="text-right">0.8139</p></td><td><p class="text-right">0.8122</p></td><td><p class="text-right">0.8391</p></td><td><p class="text-right">0.8189</p></td></tr><tr><th><p>20</p></th><td><p class="text-right">0.9109</p></td><td><p class="text-right">0.8126</p></td><td><p class="text-right">0.8108</p></td><td><p class="text-right">0.8103</p></td><td><p class="text-right">0.8362</p></td></tr><tr><th><p>55</p></th><td><p class="text-right">0.9112</p></td><td><p class="text-right">0.9114</p></td><td><p class="text-right">1.0128</p></td><td><p class="text-right">0.9123</p></td><td><p class="text-right">0.9369</p></td></tr><tr><th><p>148</p></th><td><p class="text-right">1.214</p></td><td><p class="text-right">1.111</p></td><td><p class="text-right">1.213</p></td><td><p class="text-right">1.111</p></td><td><p class="text-right">1.162</p></td></tr><tr><th><p>403</p></th><td><p class="text-right">1.816</p></td><td><p class="text-right">2.015</p></td><td><p class="text-right">1.814</p></td><td><p class="text-right">1.816</p></td><td><p class="text-right">1.865</p></td></tr><tr><th><p>1097</p></th><td><p class="text-right">4.225</p></td><td><p class="text-right">3.823</p></td><td><p class="text-right">3.629</p></td><td><p class="text-right">4.357</p></td><td><p class="text-right">4.008</p></td></tr><tr><th><p>2981</p></th><td><p class="text-right">13.58</p></td><td><p class="text-right">13.19</p></td><td><p class="text-right">12.99</p></td><td><p class="text-right">13.19</p></td><td><p class="text-right">13.23</p></td></tr><tr><th><p>8103</p></th><td><p class="text-right">46.80</p></td><td><p class="text-right">46.62</p></td><td><p class="text-right">45.59</p></td><td><p class="text-right">48.13</p></td><td><p class="text-right">46.78</p></td></tr><tr><th><p>22026</p></th><td><p class="text-right">379.2</p></td><td><p class="text-right">308.3</p></td><td><p class="text-right">280.3</p></td><td><p class="text-right">269.1</p></td><td><p class="text-right">309.2</p></td></tr><tr><th><p>59874</p></th><td><p class="text-right">1892</p></td><td><p class="text-right">1876</p></td><td><p class="text-right">1883</p></td><td><p class="text-right">1904</p></td><td><p class="text-right">1889</p></td></tr><tr><th><p>162755</p></th><td><p class="text-right">14710</p></td><td><p class="text-right">14720</p></td><td><p class="text-right">14660</p></td><td><p class="text-right">14380</p></td><td><p class="text-right">14620</p></td></tr></table><div class="flex flex-col items-center not-prose"><img src="https://blog-cms.joeyates.info/api/media/file/folder-backup-time-linear-scale.png" alt="Adding each new message got slower as the mailbox size grew" width="633" height="458"><div class="mt-1 text-sm text-gray-500 text-center">Adding each new message got slower as the mailbox size grew</div></div><p>While these are the results of the "delayed metadata" strategy:</p><table><tr><th><p>Count</p></th><th><p>Run 1</p></th><th><p>Run 2</p></th><th><p>Run 3</p></th><th><p>Run 4</p></th><th><p>Average</p></th></tr><tr><th><p>1</p></th><td><p class="text-right">0.8096</p></td><td><p class="text-right">0.9128</p></td><td><p class="text-right">0.8115</p></td><td><p class="text-right">0.8109</p></td><td><p class="text-right">0.8362</p></td></tr><tr><th><p>3</p></th><td><p class="text-right">0.8102</p></td><td><p class="text-right">0.8104</p></td><td><p class="text-right">0.8124</p></td><td><p class="text-right">0.8114</p></td><td><p class="text-right">0.8111</p></td></tr><tr><th><p>7</p></th><td><p class="text-right">0.8110</p></td><td><p class="text-right">0.8106</p></td><td><p class="text-right">0.8105</p></td><td><p class="text-right">0.8108</p></td><td><p class="text-right">0.8107</p></td></tr><tr><th><p>20</p></th><td><p class="text-right">0.8107</p></td><td><p class="text-right">0.8107</p></td><td><p class="text-right">0.8123</p></td><td><p class="text-right">0.8108</p></td><td><p class="text-right">0.8111</p></td></tr><tr><th><p>55</p></th><td><p class="text-right">0.9129</p></td><td><p class="text-right">0.9109</p></td><td><p class="text-right">0.9111</p></td><td><p class="text-right">0.9107</p></td><td><p class="text-right">0.9114</p></td></tr><tr><th><p>148</p></th><td><p class="text-right">1.011</p></td><td><p class="text-right">1.112</p></td><td><p class="text-right">1.011</p></td><td><p class="text-right">1.012</p></td><td><p class="text-right">1.037</p></td></tr><tr><th><p>403</p></th><td><p class="text-right">1.614</p></td><td><p class="text-right">1.714</p></td><td><p class="text-right">1.617</p></td><td><p class="text-right">1.614</p></td><td><p class="text-right">1.640</p></td></tr><tr><th><p>1097</p></th><td><p class="text-right">3.126</p></td><td><p class="text-right">3.120</p></td><td><p class="text-right">3.222</p></td><td><p class="text-right">4.632</p></td><td><p class="text-right">3.525</p></td></tr><tr><th><p>2981</p></th><td><p class="text-right">7.843</p></td><td><p class="text-right">9.051</p></td><td><p class="text-right">9.756</p></td><td><p class="text-right">7.944</p></td><td><p class="text-right">8.649</p></td></tr><tr><th><p>8103</p></th><td><p class="text-right">19.59</p></td><td><p class="text-right">23.61</p></td><td><p class="text-right">22.86</p></td><td><p class="text-right">21.10</p></td><td><p class="text-right">21.79</p></td></tr><tr><th><p>22026</p></th><td><p class="text-right">69.71</p></td><td><p class="text-right">70.05</p></td><td><p class="text-right">65.54</p></td><td><p class="text-right">60.77</p></td><td><p class="text-right">66.52</p></td></tr><tr><th><p>59874</p></th><td><p class="text-right">175.1</p></td><td><p class="text-right">165.5</p></td><td><p class="text-right">163.8</p></td><td><p class="text-right">172.5</p></td><td><p class="text-right">169.2</p></td></tr><tr><th><p>162755</p></th><td><p class="text-right">462.1</p></td><td><p class="text-right">443.2</p></td><td><p class="text-right">478.1</p></td><td><p class="text-right">467.0</p></td><td><p class="text-right">462.6</p></td></tr></table><div class="flex flex-col items-center not-prose"><img src="https://blog-cms.joeyates.info/api/media/file/backup-time-per-message-linear-scale.png" alt="The delayed metadata strategy is much better for large mailboxes" width="633" height="458"><div class="mt-1 text-sm text-gray-500 text-center">The delayed metadata strategy is much better for large mailboxes</div></div><p>With small mailboxes, times are more or less the same, but as the number of messages grows, the new strategy is <b>much</b> faster:</p><p>As was clear from the start, re-writing the metadata file each time a new message was added was only going to get worse. In fact, the <em>per message</em> backup time grows linearly with the "straight to disk", while it remains more or less constant with the new strategy:</p><h2>How Much Faster?</h2><p>In these benchmarks, while the new strategy changed nothing for small mailboxes, it showed a more than 30x speed improvement for mailboxes with more than 150 000 messages.</p><div class="flex flex-col items-center not-prose"><img src="https://blog-cms.joeyates.info/api/media/file/speed-improvement.png" alt="The delayed metadata strategy gives 30x speed improvement for very large mailboxes" width="633" height="458"><div class="mt-1 text-sm text-gray-500 text-center">The delayed metadata strategy gives 30x speed improvement for very large mailboxes</div></div><p>It worked!</p>
</section>
<ul class="paginate">
<li>

<a href="/posts/connecting-to-a-running-phoenix-application-deployed-on-dokku/">← Newer</a></li>
<li>

<a href="/posts/dockerfile-entrypoint-cmd-and-run-arguments/">Older →</a></li></ul>
</main>
<footer class="bottom-0 mt-6">
<hr class="mb-4">

<div class="flex flex-row justify-between text-sm">
<div>
<span>Made with</span>
<a href="https://github.com/joeyates/fermo">Fermo</a>
</div>
<p>&copy; Joe Yates 2023</p>
</div></footer>
</div></body></html>
